-- Una tabla temporal no puede tener una restricci√≥n "foreign key" ni ser indexada, tampoco puede ser referenciada por una vista.
-- para ver las tablas temporales, debemos tipear: SELECT * FROM tempdb..sysobjects;
USE [GD2C2014]

GO

IF NOT EXISTS (SELECT * FROM sys.schemas WHERE name='LOS_DESCONOCIDOS')
BEGIN
    -- The schema must be run in its own batch!
	EXEC ('CREATE SCHEMA [LOS_DESCONOCIDOS] AUTHORIZATION [gd]')
END
GO

/*
DROP TABLE [LOS_DESCONOCIDOS].FUNCIONALIDADESxROL
DROP TABLE [LOS_DESCONOCIDOS].FUNCIONALIDADES
DROP TABLE [LOS_DESCONOCIDOS].HABITACIONESxHOTELxRESERVA
DROP TABLE [LOS_DESCONOCIDOS].RESERVAS
DROP TABLE [LOS_DESCONOCIDOS].CLIENTES
DROP TABLE [LOS_DESCONOCIDOS].USUARIOSxHOTEL
DROP TABLE [LOS_DESCONOCIDOS].ROLESxPERSONA
DROP TABLE [LOS_DESCONOCIDOS].ROLES
DROP TABLE [LOS_DESCONOCIDOS].REGIMENESxHOTEL
DROP TABLE [LOS_DESCONOCIDOS].REGIMENES
DROP TABLE [LOS_DESCONOCIDOS].TIPO_HABITACION
DROP TABLE [LOS_DESCONOCIDOS].HABITACIONES
DROP TABLE [LOS_DESCONOCIDOS].USUARIOS
DROP TABLE [LOS_DESCONOCIDOS].HOTELES
DROP TABLE [LOS_DESCONOCIDOS].PERSONAS
DROP TABLE [LOS_DESCONOCIDOS].TIPO_DOC
DROP TABLE [LOS_DESCONOCIDOS].HISTORIALCLAUSURAHOTELES
DROP SCHEMA [LOS_DESCONOCIDOS]
*/

CREATE TABLE [LOS_DESCONOCIDOS].TIPO_DOC (
ID			TINYINT NOT NULL,
TIPO 		NVARCHAR(10),

PRIMARY KEY (ID)
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].ROLES
(
ID					TINYINT IDENTITY(0,1) NOT NULL,
NOMBRE				VARCHAR(50) NOT NULL,
STATUS				BIT NOT NULL DEFAULT 1,	-- todos activos por default

PRIMARY KEY (ID)
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].FUNCIONALIDADES (
ID 				TINYINT IDENTITY(0,1) NOT NULL,
DESCRIPCION		VARCHAR(50),

PRIMARY KEY (ID)
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].FUNCIONALIDADESxROL (
FUNCIONALIDAD_ID	TINYINT NOT NULL,
ROL_ID				TINYINT NOT NULL,

PRIMARY KEY (FUNCIONALIDAD_ID, ROL_ID),
FOREIGN KEY (FUNCIONALIDAD_ID) REFERENCES [LOS_DESCONOCIDOS].FUNCIONALIDADES,
FOREIGN KEY (ROL_ID) REFERENCES [LOS_DESCONOCIDOS].ROLES,
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].PERSONAS (
ID				INT NOT NULL,
NOM_APE			VARCHAR(255),
MAIL			VARCHAR(255),
TEL				VARCHAR(255),
DIRE			VARCHAR(255),
FECHA_NAC		DATETIME,
TIPO_DOC_ID		TINYINT,
NRO_DOC			INT,
-- los siguientes campos quizas deban ir en la tabla CLIENTES. evaluar !!!
-- NACIONALIDAD
-- LOCALIDAD
-- PAIS_ORIGEN

PRIMARY KEY (ID),
FOREIGN KEY (TIPO_DOC_ID) REFERENCES [LOS_DESCONOCIDOS].TIPO_DOC,
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].USUARIOS (
-- ID 					INT NOT NULL,
USERNAME			VARCHAR(255) NOT NULL,  -- UNIQUE,
PASSWORD			VARCHAR(255),	-- mediante encriptacion SHA256
PERSONA_ID			INT NOT NULL,
INTENTOS_FALLIDOS	TINYINT NOT NULL DEFAULT 0,	-- al llegar a 3 se pone STATUS en 0
STATUS				BIT NOT NULL DEFAULT 1,

PRIMARY KEY (USERNAME),
FOREIGN KEY (PERSONA_ID) REFERENCES [LOS_DESCONOCIDOS].PERSONAS,
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].CLIENTES (
ID 				INT NOT NULL,
PERSONA_ID 		INT NOT NULL,
STATUS			BIT NOT NULL DEFAULT 1,
-- ver si los siguientes campos van en tabla PERSONAS o quedan mejor aca (segun modelo de negocios)
-- NACIONALIDAD
-- LOCALIDAD
-- PAIS_ORIGEN

PRIMARY KEY (ID),
FOREIGN KEY (PERSONA_ID) REFERENCES [LOS_DESCONOCIDOS].PERSONAS,
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].ROLESxPERSONA (
PERSONA_ID	INT NOT NULL,
ROL_ID		TINYINT NOT NULL,

PRIMARY KEY (PERSONA_ID, ROL_ID),
FOREIGN KEY (PERSONA_ID) REFERENCES [LOS_DESCONOCIDOS].PERSONAS,
FOREIGN KEY (ROL_ID) REFERENCES [LOS_DESCONOCIDOS].ROLES,
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].HOTELES (
ID 					TINYINT NOT NULL,
NOMBRE				VARCHAR(50) NOT NULL,
MAIL				VARCHAR(50),
TEL 				VARCHAR(255),
DIRE				VARCHAR(255),
CIUDAD				VARCHAR(255),
PAIS 				VARCHAR(255),
FECHA_CREACION		DATETIME,
--ADMIN_ID			INT NOT NULL,
ADMIN_USERNAME		VARCHAR(255) NOT NULL,
CANT_ESTRELLAS 		TINYINT NOT NULL,
STATUS				BIT NOT NULL DEFAULT 1,

PRIMARY KEY (ID),
FOREIGN KEY (ADMIN_USERNAME) REFERENCES [LOS_DESCONOCIDOS].USUARIOS,
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].HistorialClausuraHoteles (
ID				INT NOT NULL,
HOTEL_ID		TINYINT NOT NULL,
FECHA_INICIO	DATE NOT NULL,
FECHA_FIN		DATE NOT NULL,
MOTIVO			VARCHAR(255),

PRIMARY KEY (ID),
FOREIGN KEY (HOTEL_ID) REFERENCES [LOS_DESCONOCIDOS].HOTELES,
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].USUARIOSxHOTEL (
USERNAME 			VARCHAR(255) NOT NULL,
HOTEL_ID			TINYINT NOT NULL,

PRIMARY KEY (USERNAME, HOTEL_ID),
FOREIGN KEY (USERNAME) REFERENCES [LOS_DESCONOCIDOS].USUARIOS,
FOREIGN KEY (HOTEL_ID) REFERENCES [LOS_DESCONOCIDOS].HOTELES,
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].REGIMENES (
ID 				TINYINT NOT NULL,
DESCRIPCION		VARCHAR(255) NOT NULL,
PRECIO_BASE_USD	INT NOT NULL,

PRIMARY KEY (ID),
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].REGIMENESxHOTEL (
REGIMEN_ID		TINYINT NOT NULL,
HOTEL_ID		TINYINT NOT NULL,
STATUS			BIT NOT NULL DEFAULT 1,

PRIMARY KEY (REGIMEN_ID, HOTEL_ID),
FOREIGN KEY (REGIMEN_ID) REFERENCES [LOS_DESCONOCIDOS].REGIMENES,
FOREIGN KEY (HOTEL_ID) REFERENCES [LOS_DESCONOCIDOS].HOTELES,
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].TIPO_HABITACION (
ID 				TINYINT NOT NULL,
DESCRIPCION 	VARCHAR(255) NOT NULL,
PORCENTUAL		INT NOT NULL,

PRIMARY KEY (ID),
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].HABITACIONES (
ID 					INT NOT NULL,	-- es el Nro de Habitacion
HOTEL_ID 			TINYINT NOT NULL,
PISO 				TINYINT,
FRENTE				CHAR(1),
DESCRIPCION			VARCHAR(255),
TIPO_HABITACION_ID 	TINYINT NOT NULL,
STATUS				BIT NOT NULL DEFAULT 1,

PRIMARY KEY (ID, HOTEL_ID),
FOREIGN KEY (HOTEL_ID) REFERENCES [LOS_DESCONOCIDOS].HOTELES,
FOREIGN KEY (TIPO_HABITACION_ID) REFERENCES [LOS_DESCONOCIDOS].TIPO_HABITACION,
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].RESERVAS (
ID 					INT NOT NULL,	-- Nro de Reserva
CLIENTE_ID			INT NOT NULL,
REGIMEN_ID 			TINYINT NOT NULL,
FECHA_OPERACION		DATETIME NOT NULL,
FECHA_DESDE			DATETIME NOT NULL,
FECHA_HASTA			DATETIME NOT NULL,

PRIMARY KEY (ID),
FOREIGN KEY (CLIENTE_ID) REFERENCES [LOS_DESCONOCIDOS].CLIENTES,
FOREIGN KEY (REGIMEN_ID) REFERENCES [LOS_DESCONOCIDOS].REGIMENES,
);
GO

CREATE TABLE [LOS_DESCONOCIDOS].HABITACIONESxHOTELxRESERVA (
HABITACION_ID 				INT NOT NULL,
HOTEL_ID					TINYINT NOT NULL,
RESERVA_ID 					INT NOT NULL,

PRIMARY KEY (HABITACION_ID, RESERVA_ID),
FOREIGN KEY (HABITACION_ID, HOTEL_ID) REFERENCES [LOS_DESCONOCIDOS].HABITACIONES,
FOREIGN KEY (RESERVA_ID) REFERENCES [LOS_DESCONOCIDOS].RESERVAS,
);
GO


/******************************************************INSERTS******************************************************/


INSERT INTO [LOS_DESCONOCIDOS].TIPO_DOC VALUES(0,'PAS')
INSERT INTO [LOS_DESCONOCIDOS].TIPO_DOC VALUES(1,'L.E.')
INSERT INTO [LOS_DESCONOCIDOS].TIPO_DOC VALUES(2,'L.C.')
INSERT INTO [LOS_DESCONOCIDOS].TIPO_DOC VALUES(3,'D.N.I.')

INSERT INTO [LOS_DESCONOCIDOS].ROLES (NOMBRE) VALUES('Administrador General')
INSERT INTO [LOS_DESCONOCIDOS].ROLES (NOMBRE) VALUES('Recepcion')
INSERT INTO [LOS_DESCONOCIDOS].ROLES (NOMBRE) VALUES('Guest')

INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(0,'ABM. DE ROL');
INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(1,'LOGIN Y SEGURIDAD');
INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(2,'ABM. DE USUARIO');
INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(3,'ABM. DE CLIENTES');
INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(4,'ABM. DE HOTEL');
INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(5,'ABM. DE HABITACION');
INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(6,'ABM. REGIMEN DE ESTADIA');
INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(7,'GENERAR O MODIFICAR RESERVA');
INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(8,'CANCELAR RESERVA');
INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(9,'REGISTRAR ESTADIA');
INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(10,'REGISTRAR CONSUMIBLES');
INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(11,'FACTURAR ESTADIA');
INSERT INTO [LOS_DESCONOCIDOS].FUNCIONALIDADES VALUES(12,'LISTADO ESTADISTICO');

INSERT INTO [LOS_DESCONOCIDOS].USUARIOS (USERNAME, PASSWORD, PERSONA_ID) VALUES ('admin','w23e',0)
;
GO
